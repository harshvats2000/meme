<!DOCTYPE html>
<html>
<head>
	<title>memeVats</title>
	<meta charset="utf-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-storage.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <style type="text/css">
    	* {
		  box-sizing: border-box;
		}
    	html body {
			margin: 0;
			height: 100%;
		}
		body {
			background-color: black;
		}
		#header {
			height: 40px;
			background-color: black;
			color: white;
			position: fixed;
			top: 0;
			width: 100%;
			box-shadow: 0 2px 7px lightgrey;
		}
    	#container {
			margin: auto;
			margin-top: 40px;
		}
		@media only screen and (min-width: 700px){
			#container {
				width: 60%;
			}
		}
		#displayUsername {
			font-size: 20px;
			margin-left: 7px;
			text-transform: capitalize;
			line-height: 37px;
		}
		.img {
			width: 100%;
			height: 150px;
		}
		.box {
			float: left;
			width: 33.33%;
			border: 2px solid white;
			transition: 1s;
			cursor: pointer;
		}
		#modalImg {
			max-width: 100%;
		}
		#heading1 {
			text-align: center;
			margin-top: 50px;
			color: white;
		}
		#heading2 {
			text-align: center;
			color: white;
		}
		#heading3 {
			text-align: center;
			color: white;
		}
		#editIcon {
			float: right;
			margin: 6px;
			font-size: 26px;
			cursor: pointer;
		}
		#editModal {
			background-color: black;
		}
		/*loader*/
		#loader {
			display: none;
			margin: auto;
		}
		.lds-grid {
		  display: inline-block;
		  position: relative;
		  width: 80px;
		  height: 80px;
		}
		.lds-grid div {
		  position: absolute;
		  width: 16px;
		  height: 16px;
		  border-radius: 50%;
		  background: #fff;
		  animation: lds-grid 1.2s linear infinite;
		}
		.lds-grid div:nth-child(1) {
		  top: 8px;
		  left: 8px;
		  animation-delay: 0s;
		}
		.lds-grid div:nth-child(2) {
		  top: 8px;
		  left: 32px;
		  animation-delay: -0.4s;
		}
		.lds-grid div:nth-child(3) {
		  top: 8px;
		  left: 56px;
		  animation-delay: -0.8s;
		}
		.lds-grid div:nth-child(4) {
		  top: 32px;
		  left: 8px;
		  animation-delay: -0.4s;
		}
		.lds-grid div:nth-child(5) {
		  top: 32px;
		  left: 32px;
		  animation-delay: -0.8s;
		}
		.lds-grid div:nth-child(6) {
		  top: 32px;
		  left: 56px;
		  animation-delay: -1.2s;
		}
		.lds-grid div:nth-child(7) {
		  top: 56px;
		  left: 8px;
		  animation-delay: -0.8s;
		}
		.lds-grid div:nth-child(8) {
		  top: 56px;
		  left: 32px;
		  animation-delay: -1.2s;
		}
		.lds-grid div:nth-child(9) {
		  top: 56px;
		  left: 56px;
		  animation-delay: -1.6s;
		}
		@keyframes lds-grid {
		  0%, 100% {
		    opacity: 1;
		  }
		  50% {
		    opacity: 0.5;
		  }
		}
    </style>
</head>
<body>
	<div id="header">
		<i class="material-icons" id="editIcon">create</i>
	</div>
	<div id="container">
		<h4 id="heading1">Uploaded Memes: <span id="numOfMemes"></span></h4>
		<h4 id="heading2">Total Likes: <span id="totalLikes"></span></h4>
		<h4 id="heading3">Rank: <span id="rank"></span></h4>
		<div class="lds-grid" id="loader"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
		<div id="myModal" class="modal fade" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body" style="text-align: center;">
                	<img src="" id="modalImg">
                </div>
                <div class="modal-footer" style="text-align: center;">
                    <div id="likes"></div>
                    <div id="dislikes"></div>
                </div>
            </div>

        </div>
    </div>
	</div>
	<!-- edit Modal starts -->
	<div id="editModal" class="modal fade" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h2 style="text-align: center;">Profile</h2>
                </div>
                <div class="modal-body" style="text-align: center;">
                	<input type="username" name="username" id="username" class="mdl-textfield__input"><br>
                	<input type="email" name="email" id="email" class="mdl-textfield__input">
                </div>
                <div class="modal-footer" style="text-align: center;">
                    <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect" id="saveBtn">Save</button>
                </div>
            </div>

        </div>
    </div>
	<!-- edit modal ends -->

<script type="text/javascript">
// Your web app's Firebase configuration
var firebaseConfig = {
    apiKey: "AIzaSyCMECXTcIB89Jz4OPJyT8pWHbaHwgezHUQ",
    authDomain: "meme-a8183.firebaseapp.com",
    databaseURL: "https://meme-a8183.firebaseio.com",
    projectId: "meme-a8183",
    storageBucket: "meme-a8183.appspot.com",
    messagingSenderId: "505723637281",
    appId: "1:505723637281:web:dca3babc6b8a80485d1d60",
    measurementId: "G-EHK7BB5H50"
};
// Initialize Firebase
firebase.initializeApp(firebaseConfig);
firebase.analytics();

var storageRef = firebase.storage().ref();
var databaseRef = firebase.database().ref();
var auth = firebase.auth();
var username;
document.getElementById('loader').style.display = 'block';

auth.onAuthStateChanged(firebaseUser =>  {
	if(firebaseUser) {
		console.log('user is logged in.');
		displayUsername();
		//get the total number of uploaded memes
		databaseRef.child('users/' +auth.currentUser.uid + '/uploadedMemes').once('value', snap => {
				document.getElementById('numOfMemes').innerHTML = snap.numChildren();
		});
		//get total number of likes
		databaseRef.child('users/' + auth.currentUser.uid).once('value', snap => {
			document.getElementById('totalLikes').innerHTML = -snap.val().totalLikesGot;
		})
		//getRank
		var i =1;
		databaseRef.child('users/').orderByChild('totalLikesGot').on('child_added', snap => {
			if(username == snap.val().username){
				document.getElementById('rank').innerHTML = i;
			}
			i++;
		})
		displayUploadedMemes();
		document.getElementById('editIcon').addEventListener('click', () => {
			editProfile();
		});
		document.getElementById('saveBtn').addEventListener('click', () => {
			saveProfile();
		})
	} else {
		console.log('user is logged out.');
	}
})

function displayUsername() {
	databaseRef.child('users/' + auth.currentUser.uid).once('value', snap => {
		username = snap.val().username;
		var span = document.createElement('span');
		span.id = 'displayUsername';
		var t = document.createTextNode(username);
		span.appendChild(t);
		document.getElementById('header').appendChild(span);
	})
}


function displayUploadedMemes() {
	databaseRef.child('users/' + auth.currentUser.uid + '/uploadedMemes').orderByChild('timestamp').on('child_added', snap => {

		var div1 = document.createElement('div');
		div1.className = 'box';
		var img = document.createElement('img');
		img.className = 'img';
		div1.appendChild(img);
		var name = snap.key;
		var turl;

		document.getElementById('container').appendChild(div1);
		storageRef.child('memes/' + name + '.png').getDownloadURL()
		.then((url) => {
			turl = url;
			img.src = url;
			document.getElementById('loader').style.display = 'none';
		})
		.catch(error => {
			alert(error);
		})
		var likes;
		var dislikes;
		//get number of likes and dislikes
		databaseRef.child('memes/' + name).once('value', snap => {
			likes = snap.val().likes;
			dislikes = snap.val().dislikes;
		})

		div1.addEventListener('click', () => {
			$("#myModal").modal('toggle');
			document.getElementById('modalImg').src = turl;
			document.getElementById('likes').innerHTML = 'Likes: ' + likes;
			document.getElementById('dislikes').innerHTML = 'Dislikes ' + dislikes;
		})
	})
}

function editProfile() {
	$("#editModal").modal('toggle');
	databaseRef.child('users/' + auth.currentUser.uid).on('value', snap => {
		document.getElementById('username').value = snap.val().username;
		document.getElementById('email').value = snap.val().email;
	})
}

function saveProfile() {
	var a = document.getElementById('username').value;
	var b = document.getElementById('email').value;
	databaseRef.child('users/' + auth.currentUser.uid).update({
		username: a,
		email: b
	})
	.then(() => {
		window.location.href = 'user.html';
	});
}
</script>
</body>
</html>
